---
title: "Querying and plotting using the simpsons database"
author: "Jordan Sibley"
author: "Jordan Sibley and Elizabeth Peterson"
date: "2025-05-10"
execute: 
  eval: true
  message: false
  warning: false
format:
  html:
    toc: true
embed-resources: true
---

## Overview 

description of what this doc does 


## Database query question 

Using the Simpsons database, I aim to answer the question: which characters have spoken the most total words, and what genders are represented among the top 12?



## Connect to database 

```{r}
# Read in libraries 
library(tidyverse)
library(here)
library(DBI)
library(duckdb)
library(dbplyr)
library(showtext) 
```

```{r}
# Connect to simpsons database 
conn <- DBI::dbConnect(duckdb::duckdb(),
                       dbdir="build_simp_database/simpsons.db")
```

## Query database 

Here is the query to get the data I need to create the plot to answer my question: 

```{sql}
SELECT characters.name, characters.gender, SUM(script_lines.word_count) AS total_word_count 
  FROM script_lines
  LEFT JOIN characters 
    ON script_lines.character_id = characters.id
  WHERE script_lines.speaking_line = TRUE
  GROUP BY characters.name, characters.gender
  ORDER BY total_word_count DESC
  LIMIT 12;
```

```{r}
# Query database using DBI connection 
top_lines_query <- dbGetQuery(conn, "SELECT characters.name, characters.gender, SUM(script_lines.word_count) AS total_word_count 
  FROM script_lines
  LEFT JOIN characters 
    ON script_lines.character_id = characters.id
  WHERE script_lines.speaking_line = TRUE
  GROUP BY characters.name, characters.gender
  ORDER BY total_word_count DESC
  LIMIT 12;")
```


## Data Visualization 

font source: https://www.dafont.com/simpsonfont.font
```{r}
# Import simpsons font 
font_add(family = "Simpsonfont", regular = here('fonts', 'Simpsonfont.otf'))
showtext_auto()
```


```{r}
# Create lollipop chart to visualize chars with top spoken words 
top_lines_query |> 
  # factor order by name to maintain descending order of characters
  arrange(total_word_count) |>   
  mutate(name=factor(name, levels=name)) |> 
  # initialize ggplot 
ggplot( aes(x = name, y = total_word_count, color = gender)) + 
  # geoms for lollipop chart 
  geom_segment(aes(xend = name, yend=0)) + 
  geom_point(size = 6) + 
  # flip x y coords  
  coord_flip(clip = "off") + 
  # axis labels 
  labs(y = "Total words spoken") + 
  # custom colors for gender 
  scale_color_manual(values = c("Female" = "#DD6641", "Male" = "#357ABD")) + 
  
  # manually write character labels to include black text border 
  shadowtext::geom_shadowtext(
    aes(x = name, y = -max(total_word_count) * 0.05, label = name),  # slightly off the axis
    inherit.aes = FALSE, family = "Simpsonfont",
    size = 5,
    color = "#FCEB56", # inner font color
    bg.color = "#211E1F", # outline color
    bg.r = 0.1, # outline thickness
    hjust = 1
  ) +
  
  # theme elements 
  theme_minimal() + 
  theme(
    # remove y axis title & legend 
    axis.title.y = element_blank(),
    legend.position = "none",
   
    # Text elements 
    # hide default y labels
    axis.text.y = element_blank(),  
    # x axis title and text  
    axis.title.x = element_text(family = "Simpsonfont", size = 15, color = "#211E1F"),
    axis.text.x = element_text(family = "Simpsonfont", size = 12, color = "#211E1F"),

    # fix margins 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 130), 
    # panel background color 
    plot.background = element_rect(fill = "#F1C8CD")
  )
  
  
  

```

to do: 
add commas to x axis 
adjust x axis limits 
add title and subtitle (include number of episodes this spans ) 
fix colors of grids 












### Close the database connection 

```{r}
DBI::dbDisconnect(conn, shutdown = TRUE)
```

